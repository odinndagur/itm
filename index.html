<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link href='https://fonts.googleapis.com/css?family=Faustina' rel='stylesheet'>
    <title>Íslenskt táknmál</title>
</head>
<body onload="init()">

    <div class="container">
        <header>
            <a href="./"><div class="heading">Íslenskt táknmál</div></a>
            <div class="sign-search">
                <input type="text" name="" id="search-input" placeholder="Search for a sign" oninput="updateSearch()" onchange="updateSearch()">
            </div>
        </header>
        <div class="search-results"></div>
    </div>
    
</body>

<style>

</style>



<script type="module">
    import { load } from "./dist/sql-httpvfs.js";
    window.loadDB = load

    window.loadDB('./signtest.sqlite3').then(db => {
    window.db = db.db
    })
</script>

<script async defer>
    function init(){
        let params = {}
        window.location.search.substring(1).split('&').forEach(temp => {
            const [param, value] = temp.split('=')
            params[param] = value
        })
        if(params.sign_id){
            updateSearch(`select * from sign_fts where id =${params.sign_id}`)
        }
        else{
            updateSearch()
        }
    }

    async function updateSearch(inputQuery){
        if(!window.db){
            setTimeout(function(){
                updateSearch(inputQuery)
            },150)
            return
        }
        let inp = document.querySelector('#search-input')
        let searchValue = inp.value
        if(true){
            searchValue = searchValue + "*"
        }
        let query
        if(inp.value == ""){
            query = `select * from sign_fts order by phrase asc`
        }
        else {
            query = `select * from sign_fts where sign_fts match "${searchValue}" order by rank, phrase asc`
        }
        if(inputQuery){
            query = inputQuery
        }
        let signs = await window.db.query(query)
        let searchResultsElement = document.querySelector('.search-results')
        searchResultsElement.innerHTML = ''
        for(let sign of signs){
            // console.log(sign)
            let related_signs = sign.related_signs.split(',').map(rel => {
                const [phrase, id] = rel.split('_id_')
                return `<span class="related-sign-phrase"><a href="./?sign_id=${id}">${phrase}</a></span>`
            }).join('')

            let sign_collections = sign.collections.split(',').map(col=>{
                const [collection, id] = col.split('_id_')
                return `<span class="collection"><a href="/itm/?collection_id=${id}">${collection}</a></span>`
            }).join('')
            let el = document.createElement('div')
            el.classList.add('sign')
            el.onclick = ''
            el.innerHTML = `
            <div>
                <div class="sign-phrase">
                    <a href="/itm/?sign_id=${sign.id}">${sign.phrase}</a>
                    <span class="sign-collections">${sign_collections}</span>
                </div>
                ${related_signs}
            </div>

            `
            searchResultsElement.appendChild(el)
        }
    }
</script>
</html>